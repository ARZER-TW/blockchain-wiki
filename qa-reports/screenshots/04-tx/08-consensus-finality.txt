å…±è­˜èˆ‡æœ€çµ‚æ€§
äº¤æ˜“æµç¨‹è·¯å¾‘
Step 8/9
Mark as read
â† å€å¡Šç”Ÿç”¢
ç‹€æ…‹è½‰æ› â†’
å…±è­˜èˆ‡æœ€çµ‚æ€§
Section titled â€œå…±è­˜èˆ‡æœ€çµ‚æ€§â€
eth.build
Section titled â€œeth.buildâ€

é€é eth.build æ“ä½œæ‹œå åº­å°‡è»å•é¡Œç¯€é»ï¼Œç†è§£åˆ†æ•£å¼å…±è­˜çš„æ ¸å¿ƒæŒ‘æˆ°èˆ‡è§£æ±ºæ–¹æ¡ˆã€‚

eth.build
â€” Byzantine Generals
-
100%
+
Fullscreen
Open in eth.build
Loading eth.build...
æ¦‚è¿°
Section titled â€œæ¦‚è¿°â€

Ethereum PoS çš„å…±è­˜æ©Ÿåˆ¶ç”±å…©å€‹å”è­°çµ„æˆï¼šLMD GHOST è² è²¬ fork choiceï¼ˆé¸æ“‡éˆé ­ï¼‰ï¼ŒCasper FFG è² è²¬ finalityï¼ˆæœ€çµ‚ç¢ºèªï¼‰ã€‚é©—è­‰è€…é€é Attestation åŒæ™‚ç‚ºå…©è€…æŠ•ç¥¨ã€‚ä¸€ç­†äº¤æ˜“è¢«åŒ…å«åœ¨å€å¡Šå¾Œï¼Œç¶“éç´„ 2 å€‹ epochï¼ˆ~12.8 åˆ†é˜ï¼‰ï¼Œcheckpoint è¢« finalizeï¼Œè©²äº¤æ˜“ç²å¾—ä¸å¯é€†è½‰çš„æœ€çµ‚æ€§ã€‚

æ ¸å¿ƒåŸç†
Section titled â€œæ ¸å¿ƒåŸç†â€
é›™å±¤å…±è­˜
Section titled â€œé›™å±¤å…±è­˜â€
LMD GHOSTï¼ˆfork choiceï¼‰      Casper FFGï¼ˆfinalityï¼‰
    â”‚                              â”‚
    â”œâ”€â”€ æ¯ slot æŠ•ç¥¨               â”œâ”€â”€ æ¯ epoch é‚Šç•ŒæŠ•ç¥¨
    â”œâ”€â”€ é¸å‡ºæœ€æ–°çš„éˆé ­             â”œâ”€â”€ justify â†’ finalize
    â”œâ”€â”€ å³æ™‚ä½†å¯é€†               â”œâ”€â”€ å»¶é²ä½†ä¸å¯é€†
    â””â”€â”€ æœ€é‡å­æ¨¹åŸå‰‡              â””â”€â”€ 2/3 è¶…ç´šå¤šæ•¸æ±º
LMD GHOST
Section titled â€œLMD GHOSTâ€

Latest Message Driven - Greedy Heaviest Observed SubTreeï¼š

å¾æœ€è¿‘ä¸€å€‹ finalized checkpoint é–‹å§‹
æ¯å€‹åˆ†å‰é»ï¼Œé¸æ“‡ç´¯ç© attestation æ¬Šé‡ï¼ˆstakeï¼‰æœ€å¤§çš„å­æ¨¹
éè¿´ç›´åˆ°è‘‰ç¯€é» = éˆé ­

æ¯å€‹é©—è­‰è€…çš„ã€Œæœ€æ–°è¨Šæ¯ã€ï¼ˆlatest messageï¼‰æ˜¯ä»–æœ€è¿‘ä¸€æ¬¡ attestation æŒ‡å‘çš„å€å¡Šã€‚æ¬Šé‡è¨ˆç®—åªè€ƒæ…®æ¯å€‹é©—è­‰è€…çš„æœ€æ–°æŠ•ç¥¨ï¼Œä¸ç´¯åŠ æ­·å²æŠ•ç¥¨ã€‚

Casper FFG
Section titled â€œCasper FFGâ€

Casper the Friendly Finality Gadget åœ¨ epoch é‚Šç•Œé‹ä½œï¼š

Checkpointï¼šæ¯å€‹ epoch ç¬¬ä¸€å€‹ slot çš„å€å¡Šï¼ˆæˆ–æœ€è¿‘çš„éç©ºå€å¡Šï¼‰

æŠ•ç¥¨ï¼šæ¯å€‹é©—è­‰è€…åœ¨ attestation ä¸­åŒ…å«ï¼š

sourceï¼šç›®å‰èªç‚ºçš„æœ€æ–° justified checkpoint
targetï¼šç•¶å‰ epoch çš„ checkpoint

ç‹€æ…‹è½‰ç§»ï¼š

Genesis
â†’
justify
Justified
â†’
finalize
Finalized
Genesis
justify
	â€‹

Justified
finalize
	â€‹

Finalized

å…·é«”è¦å‰‡ï¼š

Justifyï¼šç•¶ä¸€å€‹ checkpoint æ”¶åˆ° 2/3 ä»¥ä¸Š total effective balance çš„ target æŠ•ç¥¨
Finalizeï¼šç•¶ checkpoint 
ğ¶
C è¢« justifiedï¼Œä¸” 
ğ¶
C çš„ä¸‹ä¸€å€‹ epoch çš„ checkpoint ä¹Ÿè¢« justifiedï¼Œå‰‡ 
ğ¶
C è¢« finalized

æ­£å¸¸æƒ…æ³ä¸‹çš„æ™‚åºï¼š

Epoch N         Epoch N+1       Epoch N+2
  â”‚               â”‚               â”‚
  C_N             C_{N+1}         C_{N+2}
  â”‚               â”‚               â”‚
  â””â”€â”€ justified â”€â”€â”˜â”€â”€ justified â”€â”€â”˜
                  â”‚
            C_N finalized

ä¸€å€‹ checkpoint å¾è¢« justified åˆ°è¢« finalizedï¼Œéœ€è¦å†ç­‰ä¸€å€‹ epochï¼ˆ~6.4 åˆ†é˜ï¼‰ã€‚æ‰€ä»¥ finality å»¶é² = 2 epochs = ~12.8 åˆ†é˜ã€‚

Attestation çµæ§‹
Section titled â€œAttestation çµæ§‹â€

æ¯å€‹ attestation åŒ…å«ï¼š

AttestationData:              # Pectra å¾Œï¼ˆEIP-7549ï¼‰
  slot: uint64                    # æŠ•ç¥¨çš„ slot
  beacon_block_root: bytes32      # LMD GHOST æŠ•ç¥¨ï¼ˆæŒ‡å‘å“ªå€‹å€å¡Šï¼‰
  source: Checkpoint              # FFG sourceï¼ˆæœ€æ–° justifiedï¼‰
  target: Checkpoint              # FFG targetï¼ˆç•¶å‰ epoch checkpointï¼‰


Checkpoint:
  epoch: uint64
  root: bytes32

æ³¨æ„ï¼šPectra å‡ç´šå¾Œ indexï¼ˆcommittee indexï¼‰å·²å¾ AttestationData ç§»å‡ºï¼ˆEIP-7549ï¼‰ï¼Œæ”¹ç‚ºå¤–å±¤çš„ committee_bits bitfieldï¼Œä½¿è·¨ committee èšåˆæˆç‚ºå¯èƒ½ï¼Œæ¸›å°‘ç´„ 98% çš„éˆä¸Š attestation é–‹éŠ·ã€‚

ä¸€æ¬¡ attestation åŒæ™‚å®Œæˆå…©ä»¶äº‹ï¼š

beacon_block_root = LMD GHOST æŠ•ç¥¨
source + target = Casper FFG æŠ•ç¥¨
èšåˆç°½ç« 
Section titled â€œèšåˆç°½ç« â€

åŒä¸€ committee ä¸­æŠ•ç›¸åŒå…§å®¹çš„ attestation å¯ä»¥èšåˆï¼š

ä½¿ç”¨ BLS Signatures çš„èšåˆç‰¹æ€§
å¤šå€‹ç°½ç« åˆä½µç‚ºä¸€å€‹ï¼Œå¤§å¹…æ¸›å°‘è³‡æ–™é‡
èšåˆå¾Œçš„ attestation åŒ…å«ä¸€å€‹ bitfieldï¼Œæ¨™è¨˜å“ªäº›é©—è­‰è€…åƒèˆ‡

ğœ
ğ‘
ğ‘”
ğ‘”
=
âˆ‘
ğ‘–
âˆˆ
ğ‘†
ğœ
ğ‘–
Ïƒ
agg
	â€‹

=âˆ‘
iâˆˆS
	â€‹

Ïƒ
i
	â€‹


é©—è­‰èšåˆç°½ç« åªéœ€ä¸€æ¬¡ pairing é‹ç®—ï¼Œè€Œé 
âˆ£
ğ‘†
âˆ£
âˆ£Sâˆ£ æ¬¡ç¨ç«‹é©—è­‰ã€‚

Finality ä¿è­‰
Section titled â€œFinality ä¿è­‰â€

Casper FFG çš„å®‰å…¨æ€§å»ºç«‹åœ¨ slashing æ¢ä»¶ä¸Šã€‚é©—è­‰è€…é•åä»¥ä¸‹ä»»ä¸€è¦å‰‡æœƒè¢« ç½°æ²’ï¼š

Double voteï¼šåœ¨åŒä¸€ epoch ç‚ºä¸åŒ target æŠ•ç¥¨
Surround voteï¼šæŠ•ç¥¨ 
(
ğ‘ 
1
,
ğ‘¡
1
)
(s
1
	â€‹

,t
1
	â€‹

) åŒ…åœäº†å¦ä¸€ç¥¨ 
(
ğ‘ 
2
,
ğ‘¡
2
)
(s
2
	â€‹

,t
2
	â€‹

)ï¼Œå³ 
ğ‘ 
1
<
ğ‘ 
2
<
ğ‘¡
2
<
ğ‘¡
1
s
1
	â€‹

<s
2
	â€‹

<t
2
	â€‹

<t
1
	â€‹


é€™å…©æ¢è¦å‰‡ä¿è­‰ï¼šå¦‚æœæœ‰å…©å€‹è¡çªçš„ finalized checkpointï¼Œè‡³å°‘ 1/3 çš„é©—è­‰è€…é•è¦è¢«ç½°æ²’ã€‚Pectra å¾Œå–®ä¸€ validator å¯è³ªæŠ¼è‡³ 2048 ETHï¼ˆEIP-7251ï¼‰ï¼Œvalidator æ•¸é‡å¯èƒ½æ¸›å°‘ä½†å–®ä½è³ªæŠ¼é‡å¢åŠ ï¼Œå®‰å…¨æ€§ä¸è®Šã€‚

Inactivity Leak
Section titled â€œInactivity Leakâ€

å¦‚æœè¶…é 4 å€‹ epoch æ²’æœ‰æ–°çš„ finalizationï¼ˆä¾‹å¦‚ 1/3 é©—è­‰è€…é›¢ç·šï¼‰ï¼Œå•Ÿå‹• inactivity leakï¼š

é›¢ç·šé©—è­‰è€…çš„é¤˜é¡é€æ¼¸è¢«æ‰£æ¸›
åœ¨ç·šé©—è­‰è€…çš„ç›¸å°æ¬Šé‡å¢åŠ 
æœ€çµ‚åœ¨ç·šé©—è­‰è€…è¶…é 2/3ï¼Œé‡æ–°æ¢å¾© finality
é€™ä¿è­‰äº† liveness â€” å³ä½¿å¤§è¦æ¨¡ç¯€é»æ•…éšœï¼Œç¶²è·¯æœ€çµ‚èƒ½æ¢å¾©
Pectra/Fusaka å‡ç´šæ›´æ–°ï¼ˆ2025ï¼‰
Section titled â€œPectra/Fusaka å‡ç´šæ›´æ–°ï¼ˆ2025ï¼‰â€
Pectraï¼ˆ2025/5/7ï¼‰å°å…±è­˜çš„å½±éŸ¿
Section titled â€œPectraï¼ˆ2025/5/7ï¼‰å°å…±è­˜çš„å½±éŸ¿â€
EIP-6110ï¼šé©—è­‰è€…å­˜æ¬¾ç›´æ¥å¯«å…¥ execution payloadï¼Œæ–° validator å…¥å ´å»¶é²å¾ç´„ 12 å°æ™‚é™è‡³ç´„ 13 åˆ†é˜ã€‚validator é›†åˆè®Šå‹•æ›´å¿«åæ˜ åœ¨å…±è­˜ä¸­ã€‚
EIP-7002ï¼šå¾ EL è§¸ç™¼ validator é€€å‡ºï¼Œwithdrawal credential æŒæœ‰è€…ç„¡éœ€ BLS key å³å¯é€€å‡ºã€‚é€€å‡ºå¾Œçš„é¤˜é¡é‡æ–°åˆ†é…æ›´éˆæ´»ã€‚
EIP-7251ï¼šMAX_EFFECTIVE_BALANCE æå‡è‡³ 2048 ETHï¼Œå¤§å‹è³ªæŠ¼è€…å¯åˆä½µ validatorï¼Œæ¸›å°‘ validator set å¤§å°ã€‚è¼ƒå°çš„ validator set æ„å‘³è‘— attestation èšåˆå’Œ epoch processing çš„æ•ˆç‡æå‡ã€‚
EIP-7549ï¼šcommittee index ç§»å‡º attestation dataï¼Œè·¨ committee èšåˆæ¸›å°‘ 98% çš„éˆä¸Š attestation é–‹éŠ·ï¼Œé™ä½ Beacon Block å¤§å°èˆ‡é©—è­‰æˆæœ¬ã€‚
Fusakaï¼ˆ2025/12/3ï¼‰å°å…±è­˜çš„å½±éŸ¿
Section titled â€œFusakaï¼ˆ2025/12/3ï¼‰å°å…±è­˜çš„å½±éŸ¿â€
EIP-7917ï¼šproposer é æ¸¬é€æ˜åŒ–ï¼Œæ”¹å–„ validator å°å‡ºå¡Šæ’ç¨‹çš„å¯è¦‹åº¦ï¼Œé–“æ¥æå‡ fork choice ç©©å®šæ€§ã€‚
åœ¨ Ethereum ä¸­çš„æ‡‰ç”¨
Section titled â€œåœ¨ Ethereum ä¸­çš„æ‡‰ç”¨â€
äº¤æ˜“æ‰€å…¥é‡‘ï¼šé€šå¸¸ç­‰å¾… finalityï¼ˆ~12.8 minï¼‰æ‰ç¢ºèªå…¥å¸³
è·¨éˆæ©‹ï¼šä¾è³´ finality ä¾†ç¢ºèªä¾†æºéˆçš„äº¤æ˜“
DeFi å”è­°ï¼šéƒ¨åˆ†æ“ä½œåœ¨ 1 confirmation å¾Œå³å¯ï¼Œä½†æ¸…ç®—ç­‰é«˜åƒ¹å€¼æ“ä½œæ‡‰ç­‰ finality
L2 Sequencerï¼šå°‡ batch æäº¤åˆ° L1 å¾Œï¼Œéœ€ç­‰ L1 finality æ‰ç®—æœ€çµ‚ç¢ºèª
ç¨‹å¼ç¢¼ç¯„ä¾‹
Section titled â€œç¨‹å¼ç¢¼ç¯„ä¾‹â€
import { ethers } from 'ethers';


const provider = new ethers.JsonRpcProvider('http://localhost:8545');


// --- 1. æŸ¥çœ‹å„éšæ®µçš„å€å¡Š ---
const [latest, safe, finalized] = await Promise.all([
  provider.getBlock('latest'),
  provider.getBlock('safe'),       // justified
  provider.getBlock('finalized'),  // finalized
]);


console.log('Latest block:', latest.number);
console.log('Safe block:', safe.number, `(${latest.number - safe.number} blocks behind)`);
console.log('Finalized block:', finalized.number, `(${latest.number - finalized.number} blocks behind)`);


// --- 2. æª¢æŸ¥äº¤æ˜“æ˜¯å¦å·² finalized ---
async function isFinalized(txHash) {
  const receipt = await provider.getTransactionReceipt(txHash);
  if (!receipt) return { status: 'not found' };


  const finalizedBlock = await provider.getBlock('finalized');
  if (receipt.blockNumber <= finalizedBlock.number) {
    return { status: 'finalized', block: receipt.blockNumber };
  }


  const safeBlock = await provider.getBlock('safe');
  if (receipt.blockNumber <= safeBlock.number) {
    return { status: 'justified (safe)', block: receipt.blockNumber };
  }


  return {
    status: 'confirmed but not finalized',
    block: receipt.blockNumber,
    blocksToFinality: receipt.blockNumber - finalizedBlock.number,
  };
}


// --- 3. ç­‰å¾… finality ---
async function waitForFinality(txHash, pollInterval) {
  const interval = pollInterval || 12000;
  const receipt = await provider.getTransactionReceipt(txHash);
  if (!receipt) throw new Error('Transaction not found');


  return new Promise((resolve) => {
    const check = async () => {
      const finalizedBlock = await provider.getBlock('finalized');
      if (receipt.blockNumber <= finalizedBlock.number) {
        resolve({ finalized: true, block: receipt.blockNumber });
      } else {
        setTimeout(check, interval);
      }
    };
    check();
  });
}


// --- 4. Beacon API æŸ¥çœ‹ finality checkpoint ---
// const beaconUrl = 'http://localhost:5052';
// const resp = await fetch(`${beaconUrl}/eth/v1/beacon/states/head/finality_checkpoints`);
// const data = await resp.json();
// console.log('Justified epoch:', data.data.current_justified.epoch);
// console.log('Finalized epoch:', data.data.finalized.epoch);
ç›¸é—œæ¦‚å¿µ
Section titled â€œç›¸é—œæ¦‚å¿µâ€
äº¤æ˜“ç”Ÿå‘½é€±æœŸ - æœ¬ç­†è¨˜æ˜¯æµç¨‹ç¬¬ä¸ƒæ­¥
å€å¡Šç”Ÿç”¢ - æµç¨‹ä¸Šä¸€æ­¥ï¼šå€å¡Šè¢« proposer ç”¢å‡º
ç‹€æ…‹è½‰æ› - æµç¨‹ä¸‹ä¸€æ­¥ï¼šfinalized å€å¡Šä¸­çš„äº¤æ˜“çµæœæ°¸ä¹…ç”Ÿæ•ˆ
Casper FFG - Finality gadget çš„å®Œæ•´è¦æ ¼
LMD GHOST - Fork choice rule
Attestation - é©—è­‰è€…æŠ•ç¥¨æ©Ÿåˆ¶
Beacon Chain - å…±è­˜å±¤é‹ä½œ
Validators - é©—è­‰è€…è§’è‰²èˆ‡è²¬ä»»
BLS Signatures - èšåˆç°½ç« æŠ€è¡“
BLS12-381 - BLS ä½¿ç”¨çš„æ›²ç·š
Slashing - æ‡²ç½°æ©Ÿåˆ¶ä¿éšœå®‰å…¨æ€§
RANDAO - éš¨æ©Ÿæ€§ä¾†æº
ä¸Šä¸€é¡µ
å€å¡Šç”Ÿç”¢
ä¸‹ä¸€é¡µ
ç‹€æ…‹è½‰æ›
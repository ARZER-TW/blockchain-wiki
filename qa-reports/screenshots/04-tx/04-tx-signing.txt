äº¤æ˜“ç°½å
äº¤æ˜“æµç¨‹è·¯å¾‘
Step 4/9
Mark as read
â† äº¤æ˜“æ§‹å»º
å»£æ’­èˆ‡é©—è­‰ â†’
äº¤æ˜“ç°½å
Section titled â€œäº¤æ˜“ç°½åâ€

æœ¬æ–‡èšç„¦ Ethereum ç‰¹å®šçš„å¯¦ç¾ç´°ç¯€ã€‚é€šç”¨äº¤æ˜“ç°½åç†è«–è«‹åƒè¦‹ äº¤æ˜“ç°½åã€‚

eth.build
Section titled â€œeth.buildâ€

é€é eth.build æ“ä½œ Transactions ç¯€é»ï¼Œè§€å¯Ÿäº¤æ˜“ç°½åçš„å®Œæ•´è¦–è¦ºåŒ–æµç¨‹ã€‚

eth.build
â€” Transactions (Signing)
-
100%
+
Fullscreen
Open in eth.build
Loading eth.build...
æ¦‚è¿°
Section titled â€œæ¦‚è¿°â€

Ethereum äº¤æ˜“ç°½åä½¿ç”¨ ECDSA æ¼”ç®—æ³•åœ¨ secp256k1 æ›²ç·šä¸Šå°äº¤æ˜“é›œæ¹Šé€²è¡Œç°½ç« ï¼Œç”¢ç”Ÿ (v, r, s) ä¸‰å€‹å€¼ã€‚é©—è­‰è€…å¯ä»¥ç”¨ ECRECOVER å¾ç°½ååæ¨å…¬é‘°ï¼Œé€²è€Œæ¨å°å‡ºç™¼é€è€…åœ°å€ â€” Ethereum ä¸éœ€è¦åœ¨äº¤æ˜“ä¸­é¡¯å¼åŒ…å« from æ¬„ä½ã€‚

Ethereum ç°½åç´°ç¯€
Section titled â€œEthereum ç°½åç´°ç¯€â€
ECDSA ç°½ç« æµç¨‹
Section titled â€œECDSA ç°½ç« æµç¨‹â€

çµ¦å®šç§é‘° 
ğ‘˜
kã€å¾…ç°½è¨Šæ¯é›œæ¹Š 
ğ‘§
zï¼š

ç”¢ç”Ÿéš¨æ©Ÿæ•¸ 
ğ‘Ÿ
ğ‘˜
r
k
	â€‹

ï¼ˆephemeral keyï¼‰ï¼Œ
1
â‰¤
ğ‘Ÿ
ğ‘˜
<
ğ‘›
1â‰¤r
k
	â€‹

<n
è¨ˆç®—æ›²ç·šé» 
ğ‘…
=
ğ‘Ÿ
ğ‘˜
â‹…
ğº
R=r
k
	â€‹

â‹…Gï¼Œå– 
ğ‘Ÿ
=
ğ‘…
.
ğ‘¥
m
o
d
â€‰
â€‰
ğ‘›
r=R.xmodn
è¨ˆç®— 
ğ‘ 
=
ğ‘Ÿ
ğ‘˜
âˆ’
1
(
ğ‘§
+
ğ‘Ÿ
â‹…
ğ‘˜
)
m
o
d
â€‰
â€‰
ğ‘›
s=r
k
âˆ’1
	â€‹

(z+râ‹…k)modn
è‹¥ 
ğ‘Ÿ
=
0
r=0 æˆ– 
ğ‘ 
=
0
s=0ï¼Œé‡æ–°é¸æ“‡ 
ğ‘Ÿ
ğ‘˜
r
k
	â€‹


ç°½ç« çµæœç‚º 
(
ğ‘Ÿ
,
ğ‘ 
)
(r,s)ï¼Œå„ 32 bytesã€‚

è¨Šæ¯é›œæ¹Šçš„è¨ˆç®—ï¼ˆRLP ç·¨ç¢¼ï¼‰
Section titled â€œè¨Šæ¯é›œæ¹Šçš„è¨ˆç®—ï¼ˆRLP ç·¨ç¢¼ï¼‰â€

ä¾äº¤æ˜“é¡å‹ä¸åŒï¼Œå¾…ç°½é›œæ¹Šçš„è¼¸å…¥ä¸åŒï¼š

Legacyï¼ˆpre-EIP-155ï¼‰ï¼š 
ğ‘§
=
Keccak-256
(
RLP
(
[
nonce
,
gasPrice
,
gasLimit
,
to
,
value
,
data
]
)
)
z=Keccak-256(RLP([nonce,gasPrice,gasLimit,to,value,data]))

Legacyï¼ˆEIP-155ï¼‰ï¼š 
ğ‘§
=
Keccak-256
(
RLP
(
[
nonce
,
gasPrice
,
gasLimit
,
to
,
value
,
data
,
chainId
,
0
,
0
]
)
)
z=Keccak-256(RLP([nonce,gasPrice,gasLimit,to,value,data,chainId,0,0]))

Typed Transactionï¼ˆType 2, EIP-1559ï¼‰ï¼š 
ğ‘§
=
Keccak-256
(
0x02
âˆ¥
RLP
(
[
chainId
,
nonce
,
.
.
.
]
)
)
z=Keccak-256(0x02âˆ¥RLP([chainId,nonce,...]))

v å€¼çš„å«ç¾©
Section titled â€œv å€¼çš„å«ç¾©â€

v å€¼ï¼ˆrecovery IDï¼‰è®“é©—è­‰è€…èƒ½å¾ (r, s) å”¯ä¸€ç¢ºå®šå…¬é‘°ã€‚ä¸€å€‹ r å€¼å°æ‡‰å…©å€‹å¯èƒ½çš„å…¬é‘°ï¼ˆæ©¢åœ“æ›²ç·šçš„ 
ğ‘¦
y å’Œ 
âˆ’
ğ‘¦
âˆ’yï¼‰ï¼Œv æŒ‡å®šæ˜¯å“ªä¸€å€‹ã€‚

å ´æ™¯	v å€¼	èªªæ˜
Pre-EIP-155	27 æˆ– 28	recovery ID + 27
EIP-155	chainId * 2 + 35 æˆ– 36	åŒ…å« chain IDï¼ˆEIP-155 é‡æ”¾ä¿è­·ï¼‰
Typed TX (Type 1/2/3)	0 æˆ– 1	ç´” recovery IDï¼Œchain ID åœ¨æ¬„ä½ä¸­

EIP-155 çš„ v å€¼å…¬å¼ï¼š 
ğ‘£
=
recoveryId
+
chainId
Ã—
2
+
35
v=recoveryId+chainIdÃ—2+35

Mainnetï¼ˆchainId = 1ï¼‰çš„ v å€¼ç‚º 37 æˆ– 38ã€‚

EIP-2718 Typed Transactions
Section titled â€œEIP-2718 Typed Transactionsâ€

EIP-2718 å®šç¾©äº†äº¤æ˜“çš„ envelope æ ¼å¼ï¼Œä½¿æ–°çš„äº¤æ˜“é¡å‹å¯ä»¥æ“´å±•è€Œä¸ç ´å£å‘å¾Œç›¸å®¹ï¼š

Type 0ï¼ˆLegacyï¼‰ï¼šå‚³çµ± RLP ç·¨ç¢¼
Type 1ï¼ˆEIP-2930ï¼‰ï¼šAccess list transaction
Type 2ï¼ˆEIP-1559ï¼‰ï¼šå‹•æ…‹æ‰‹çºŒè²»äº¤æ˜“
Type 3ï¼ˆEIP-4844ï¼‰ï¼šBlob transaction

Typed transaction çš„ç°½åæ ¼å¼ç‚º TransactionType || RLP(...)ï¼Œchain ID æ˜¯äº¤æ˜“æ¬„ä½çš„ä¸€éƒ¨åˆ†ï¼Œä¸å†ç·¨ç¢¼åœ¨ v ä¸­ã€‚

Signature Malleabilityï¼ˆEIP-2ï¼‰
Section titled â€œSignature Malleabilityï¼ˆEIP-2ï¼‰â€

ECDSA ç°½ç« å­˜åœ¨ malleability å•é¡Œï¼šå°æ–¼æœ‰æ•ˆç°½ç«  
(
ğ‘Ÿ
,
ğ‘ 
)
(r,s)ï¼Œ
(
ğ‘Ÿ
,
ğ‘›
âˆ’
ğ‘ 
)
(r,nâˆ’s) ä¹Ÿæ˜¯æœ‰æ•ˆç°½ç« ã€‚Ethereum é€é EIP-2 è¦å®š 
ğ‘ 
s å¿…é ˆåœ¨æ›²ç·šéšçš„ä¸‹åŠéƒ¨åˆ†ï¼ˆ
ğ‘ 
â‰¤
ğ‘›
/
2
sâ‰¤n/2ï¼‰ï¼Œæ¶ˆé™¤é€™å€‹å•é¡Œã€‚

RFC 6979 ç¢ºå®šæ€§ k å€¼
Section titled â€œRFC 6979 ç¢ºå®šæ€§ k å€¼â€

ç‚ºé¿å… 
ğ‘Ÿ
ğ‘˜
r
k
	â€‹

 çš„éš¨æ©Ÿæ•¸å“è³ªå•é¡Œï¼Œç¾ä»£å¯¦ä½œä½¿ç”¨ RFC 6979ï¼š

ğ‘Ÿ
ğ‘˜
=
HMAC-DRBG
(
ğ‘˜
,
ğ‘§
)
r
k
	â€‹

=HMAC-DRBG(k,z)

å¾ç§é‘°å’Œè¨Šæ¯é›œæ¹Šç¢ºå®šæ€§åœ°æ¨å° 
ğ‘Ÿ
ğ‘˜
r
k
	â€‹

ï¼ŒåŒä¸€ç­†äº¤æ˜“æ°¸é ç”¢ç”Ÿç›¸åŒç°½ç« ã€‚

åœ¨ Ethereum ä¸­çš„æ‡‰ç”¨
Section titled â€œåœ¨ Ethereum ä¸­çš„æ‡‰ç”¨â€
äº¤æ˜“èªè­‰ï¼šæ¯ç­†éˆä¸Šäº¤æ˜“éƒ½å¿…é ˆæœ‰åˆæ³•ç°½ç« 
EIP-712 çµæ§‹åŒ–ç°½ç« ï¼šdApp è«‹æ±‚ä½¿ç”¨è€…å°çµæ§‹åŒ–è³‡æ–™ç°½ç« ï¼ˆpermitã€order ç­‰ï¼‰
EIP-191 å€‹äººç°½ç« ï¼špersonal_sign å°ä»»æ„è¨Šæ¯ç°½ç« ï¼Œå‰ç¶´ \x19Ethereum Signed Message:\n
åˆç´„é©—è­‰ï¼šåˆç´„å…§ç”¨ ecrecover precompileï¼ˆECRECOVERï¼‰é©—è­‰ç°½ç« 
Account Abstraction (ERC-4337)ï¼šå¯è‡ªå®šç¾©ç°½ç« é©—è­‰é‚è¼¯
ç¨‹å¼ç¢¼ç¯„ä¾‹
Section titled â€œç¨‹å¼ç¢¼ç¯„ä¾‹â€
import { ethers } from 'ethers';


const privateKey = '0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80';
const wallet = new ethers.Wallet(privateKey);


// --- 1. ç°½ç½²äº¤æ˜“ ---
const tx = {
  type: 2,
  chainId: 1n,
  nonce: 0,
  to: '0x70997970C51812dc3A010C7d01b50e0d17dc79C8',
  value: ethers.parseEther('1.0'),
  maxFeePerGas: ethers.parseUnits('30', 'gwei'),
  maxPriorityFeePerGas: ethers.parseUnits('2', 'gwei'),
  gasLimit: 21000n,
};


const signedTx = await wallet.signTransaction(tx);
console.log('Signed TX (hex):', signedTx);


// è§£æå·²ç°½åäº¤æ˜“ï¼ŒæŸ¥çœ‹ v, r, s
const parsed = ethers.Transaction.from(signedTx);
console.log('v:', parsed.signature.v);
console.log('r:', parsed.signature.r);
console.log('s:', parsed.signature.s);
console.log('Recovery ID:', parsed.signature.yParity);


// --- 2. å¾ç°½åæ¢å¾©åœ°å€ï¼ˆECRECOVERï¼‰ ---
const txHash = parsed.unsignedHash;
const recoveredAddress = ethers.recoverAddress(txHash, parsed.signature);
console.log('Recovered:', recoveredAddress);
console.log('Match:', recoveredAddress === wallet.address);


// --- 3. EIP-191 å€‹äººè¨Šæ¯ç°½ç«  ---
const message = 'Hello Ethereum';
const personalSig = await wallet.signMessage(message);
console.log('Personal Signature:', personalSig);


// é©—è­‰
const recoveredFromMsg = ethers.verifyMessage(message, personalSig);
console.log('Verified signer:', recoveredFromMsg);


// --- 4. EIP-712 çµæ§‹åŒ–è³‡æ–™ç°½ç«  ---
const domain = {
  name: 'MyDApp',
  version: '1',
  chainId: 1,
  verifyingContract: '0xCcCCccccCCCCcCCCCCCcCcCccCcCCCcCcccccccC',
};


const types = {
  Transfer: [
    { name: 'to', type: 'address' },
    { name: 'amount', type: 'uint256' },
    { name: 'nonce', type: 'uint256' },
  ],
};


const transferData = {
  to: '0x70997970C51812dc3A010C7d01b50e0d17dc79C8',
  amount: ethers.parseEther('100'),
  nonce: 0n,
};


const typedSig = await wallet.signTypedData(domain, types, transferData);
const typedSigner = ethers.verifyTypedData(domain, types, transferData, typedSig);
console.log('EIP-712 Signer:', typedSigner);
ç›¸é—œæ¦‚å¿µ
Section titled â€œç›¸é—œæ¦‚å¿µâ€
äº¤æ˜“ç°½åï¼ˆé€šç”¨æ¦‚å¿µï¼‰ - è·¨éˆé€šç”¨çš„ç°½åç†è«–
äº¤æ˜“ç”Ÿå‘½é€±æœŸ - æœ¬ç­†è¨˜æ˜¯æµç¨‹ç¬¬ä¸‰æ­¥
äº¤æ˜“æ§‹å»º - æµç¨‹ä¸Šä¸€æ­¥ï¼šç”¢ç”Ÿå¾…ç°½è³‡æ–™
äº¤æ˜“å»£æ’­èˆ‡é©—è­‰ - æµç¨‹ä¸‹ä¸€æ­¥ï¼šç°½å¥½çš„äº¤æ˜“é€å‡º
ECDSA - ç°½ç« æ¼”ç®—æ³•çš„æ•¸å­¸åŸç†
secp256k1 - ä½¿ç”¨çš„æ©¢åœ“æ›²ç·š
Keccak-256 - è¨ˆç®—äº¤æ˜“é›œæ¹Š
ECRECOVER - å¾ç°½ç« æ¢å¾©å…¬é‘°
EIP-155 é‡æ”¾ä¿è­· - v å€¼ä¸­ç·¨ç¢¼ chain ID
æ•¸ä½ç°½ç« æ¦‚è¿° - æ•¸ä½ç°½ç« çš„é€šç”¨æ¦‚å¿µ
ä¸Šä¸€é¡µ
äº¤æ˜“æ§‹å»º
ä¸‹ä¸€é¡µ
äº¤æ˜“å»£æ’­èˆ‡é©—è­‰
äº¤æ˜“å»£æ’­èˆ‡é©—è­‰
äº¤æ˜“æµç¨‹è·¯å¾‘
Step 5/9
Mark as read
â† äº¤æ˜“ç°½å
è¨˜æ†¶æ±  â†’
äº¤æ˜“å»£æ’­èˆ‡é©—è­‰
Section titled â€œäº¤æ˜“å»£æ’­èˆ‡é©—è­‰â€
æ¦‚è¿°
Section titled â€œæ¦‚è¿°â€

ç°½å¥½çš„äº¤æ˜“é€é JSON-RPCï¼ˆeth_sendRawTransactionï¼‰æäº¤çµ¦ Ethereum ç¯€é»ï¼Œç¯€é»åŸ·è¡Œä¸€ç³»åˆ—é©—è­‰æª¢æŸ¥å¾Œï¼Œå°‡äº¤æ˜“åŠ å…¥æœ¬åœ° è¨˜æ†¶æ±  ä¸¦é€é DevP2P gossip å”è­°å‚³æ’­åˆ°å…¶ä»– peerã€‚æ¯å€‹æ”¶åˆ°äº¤æ˜“çš„ç¯€é»æœƒç¨ç«‹é©—è­‰ï¼Œä¸ä¿¡ä»»å‚³æ’­ä¾†æºã€‚

æ ¸å¿ƒåŸç†
Section titled â€œæ ¸å¿ƒåŸç†â€
æäº¤æ–¹å¼
Section titled â€œæäº¤æ–¹å¼â€

ä½¿ç”¨è€…ï¼ˆæˆ– dAppï¼‰å°‡å·²ç°½åçš„åŸå§‹äº¤æ˜“ hex é€é RPC æäº¤ï¼š

POST /
{
  "jsonrpc": "2.0",
  "method": "eth_sendRawTransaction",
  "params": ["0x02f8...signed_tx_hex"],
  "id": 1
}

ç¯€é»æ”¶åˆ°å¾Œé€²è¡Œé©—è­‰ï¼Œé€šéå‰‡å›å‚³äº¤æ˜“é›œæ¹Šï¼›å¤±æ•—å‰‡å›å‚³éŒ¯èª¤ã€‚

ç¯€é»é©—è­‰æµç¨‹
Section titled â€œç¯€é»é©—è­‰æµç¨‹â€

æ¯å€‹ç¯€é»å°æ”¶åˆ°çš„äº¤æ˜“åŸ·è¡Œä»¥ä¸‹æª¢æŸ¥ï¼ˆé †åºå¯èƒ½å› å®¢æˆ¶ç«¯è€Œç•°ï¼‰ï¼š

1. æ ¼å¼é©—è­‰
   â”œâ”€â”€ äº¤æ˜“ RLP è§£ç¢¼æ˜¯å¦æˆåŠŸ
   â”œâ”€â”€ æ¬„ä½å‹åˆ¥æ˜¯å¦æ­£ç¢º
   â””â”€â”€ äº¤æ˜“å¤§å° <= 131,072 bytes (128 KB)


2. ç°½ç« é©—è­‰
   â”œâ”€â”€ ECRECOVER æ¢å¾©å…¬é‘°
   â”œâ”€â”€ æ¨å°åœ°å€ = ç™¼é€è€…åœ°å€
   â”œâ”€â”€ v å€¼å°æ‡‰æ­£ç¢º chain ID
   â””â”€â”€ s <= secp256k1 order / 2ï¼ˆEIP-2 low-sï¼‰


3. ç‹€æ…‹é©—è­‰
   â”œâ”€â”€ ç™¼é€è€…å¸³æˆ¶å­˜åœ¨ï¼ˆæˆ– value+gas è¶³ä»¥å‰µå»ºï¼‰
   â”œâ”€â”€ nonce == å¸³æˆ¶ç•¶å‰ nonceï¼ˆæˆ– pending nonceï¼‰
   â”œâ”€â”€ é¤˜é¡ >= value + gasLimit * maxFeePerGas
   â””â”€â”€ gasLimit >= intrinsic gasï¼ˆ21000 + calldata costï¼‰


4. è²»ç”¨é©—è­‰
   â”œâ”€â”€ maxFeePerGas >= ç•¶å‰ baseFeeï¼ˆå¯å¯¬é¬†ï¼‰
   â””â”€â”€ maxPriorityFeePerGas >= 0
ç°½ç« é©—è­‰ç´°ç¯€
Section titled â€œç°½ç« é©—è­‰ç´°ç¯€â€

é€™æ˜¯æ•´å€‹é©—è­‰ä¸­å¯†ç¢¼å­¸æœ€å¯†é›†çš„éƒ¨åˆ†ï¼š

å¾å·²ç°½åäº¤æ˜“è§£æå‡º (v, r, s) å’Œäº¤æ˜“æ¬„ä½
é‡æ–°åºåˆ—åŒ–äº¤æ˜“æ¬„ä½ï¼ˆä¸å«ç°½ç« ï¼‰ï¼Œè¨ˆç®— Keccak-256 é›œæ¹Š 
ğ‘§
z
å‘¼å« ECRECOVERï¼šå¾ 
(
ğ‘§
,
ğ‘£
,
ğ‘Ÿ
,
ğ‘ 
)
(z,v,r,s) æ¢å¾©å…¬é‘° 
ğ¾
K
è¨ˆç®—åœ°å€ï¼š
addr
=
Keccak-256
(
ğ¾
)
[
12
:
32
]
addr=Keccak-256(K)[12:32]
æ­¤åœ°å€å³ç‚ºäº¤æ˜“ç™¼é€è€…ï¼ˆfromï¼‰

æ•´å€‹éç¨‹ä¸éœ€è¦äº‹å…ˆçŸ¥é“ç™¼é€è€…æ˜¯èª° â€” èº«ä»½å®Œå…¨ç”±ç°½ç« æ•¸å­¸æ¨å°ã€‚

Intrinsic Gas
Section titled â€œIntrinsic Gasâ€

äº¤æ˜“åœ¨ EVM åŸ·è¡Œå‰å°±è¦æ¶ˆè€—çš„å›ºå®š gasï¼š

é …ç›®	Gas æˆæœ¬
åŸºç¤äº¤æ˜“	21,000
åˆç´„éƒ¨ç½²ï¼ˆto = nullï¼‰	é¡å¤– 32,000
calldata ä¸­çš„é›¶ byte	æ¯ byte 4 gas
calldata ä¸­çš„éé›¶ byte	æ¯ byte 16 gas
Access list entryï¼ˆåœ°å€ï¼‰	2,400
Access list entryï¼ˆstorage keyï¼‰	1,900

gasLimit å¿…é ˆ >= intrinsic gasï¼Œå¦å‰‡äº¤æ˜“ç›´æ¥è¢«æ‹’çµ•ã€‚

DevP2P Gossip å‚³æ’­
Section titled â€œDevP2P Gossip å‚³æ’­â€

Ethereum ä½¿ç”¨çµæ§‹åŒ–çš„ P2P ç¶²è·¯ï¼š

Discoveryï¼šç”¨ discv4/discv5 å”è­°ï¼ˆåŸºæ–¼ Kademlia DHTï¼‰ç™¼ç¾ peers
é€£ç·šï¼šRLPx åŠ å¯†å‚³è¼¸ï¼ˆECIES æ¡æ‰‹ + AES-256-CTRï¼‰
äº¤æ˜“å‚³æ’­ï¼š
ç¯€é»å‘éƒ¨åˆ† peers ç™¼é€å®Œæ•´äº¤æ˜“ï¼ˆTransactions è¨Šæ¯ï¼‰
å‘å…¶é¤˜ peers åªç™¼é€äº¤æ˜“é›œæ¹Šï¼ˆNewPooledTransactionHashesï¼‰
æ”¶åˆ°é›œæ¹Šçš„ç¯€é»æŒ‰éœ€è«‹æ±‚å®Œæ•´äº¤æ˜“ï¼ˆGetPooledTransactionsï¼‰

é€™ç¨®æ··åˆç­–ç•¥å¹³è¡¡äº†å»¶é²å’Œé »å¯¬ã€‚ä¸€ç­†äº¤æ˜“é€šå¸¸åœ¨ 1-3 ç§’å…§å‚³æ’­åˆ°å¤§éƒ¨åˆ†ç¶²è·¯ç¯€é»ã€‚

ç§æœ‰äº¤æ˜“ï¼ˆFlashbots / MEVï¼‰
Section titled â€œç§æœ‰äº¤æ˜“ï¼ˆFlashbots / MEVï¼‰â€

ç‚ºé¿å…è¢« MEV searcher æ¶è·‘ï¼Œå¯ä»¥ç¹éå…¬é–‹ mempoolï¼š

Flashbots Protectï¼šäº¤æ˜“ç›´æ¥ç™¼é€çµ¦ block builderï¼Œä¸é€²å…¥å…¬é–‹ mempool
Private mempoolï¼šéƒ¨åˆ† builder æä¾›ç§æœ‰äº¤æ˜“æäº¤ç«¯é»
é€™äº›äº¤æ˜“å…¶ä»–ç¯€é»åœ¨å€å¡Šä¸Šéˆå‰çœ‹ä¸åˆ°
åœ¨ Ethereum ä¸­çš„æ‡‰ç”¨
Section titled â€œåœ¨ Ethereum ä¸­çš„æ‡‰ç”¨â€
æ¨™æº–äº¤æ˜“ï¼šé€éå…¬é–‹ RPC æäº¤ã€gossip å‚³æ’­ã€æ‰€æœ‰ç¯€é»å¯è¦‹
MEV ä¿è­·äº¤æ˜“ï¼šé€é Flashbots ç­‰ç§æœ‰é€šé“ç›´æ¥é€åˆ° builder
Bundleï¼šå¤šç­†äº¤æ˜“æ‰“åŒ…ç‚ºåŸå­æ“ä½œï¼Œå…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨ä¸åŒ…å«
ç¯€é»åŒæ­¥ï¼šæ–°ç¯€é»åŠ å…¥ç¶²è·¯æ™‚ä¹Ÿé€é DevP2P åŒæ­¥æ­·å²å€å¡Š
ç¨‹å¼ç¢¼ç¯„ä¾‹
Section titled â€œç¨‹å¼ç¢¼ç¯„ä¾‹â€
import { ethers } from 'ethers';


const provider = new ethers.JsonRpcProvider('http://localhost:8545');
const wallet = new ethers.Wallet(process.env.PRIVATE_KEY, provider);


// --- 1. æ¨™æº–å»£æ’­ ---
const tx = await wallet.sendTransaction({
  to: '0xRecipient',
  value: ethers.parseEther('0.1'),
});
console.log('TX Hash:', tx.hash);


// ç­‰å¾…è¢«åŒ…å«åœ¨å€å¡Šä¸­
const receipt = await tx.wait();
console.log('Confirmed in block:', receipt.blockNumber);


// --- 2. æ‰‹å‹•å»£æ’­åŸå§‹äº¤æ˜“ ---
const signedTx = await wallet.signTransaction({
  type: 2,
  to: '0xRecipient',
  value: ethers.parseEther('0.1'),
  chainId: 1n,
  nonce: await provider.getTransactionCount(wallet.address, 'pending'),
  maxFeePerGas: ethers.parseUnits('30', 'gwei'),
  maxPriorityFeePerGas: ethers.parseUnits('2', 'gwei'),
  gasLimit: 21000n,
});


const txResponse = await provider.broadcastTransaction(signedTx);
console.log('Broadcasted:', txResponse.hash);


// --- 3. é©—è­‰å·²å­˜åœ¨çš„äº¤æ˜“ç°½ç«  ---
const existingTx = await provider.getTransaction(tx.hash);
const recoveredFrom = ethers.recoverAddress(
  ethers.Transaction.from(existingTx).unsignedHash,
  existingTx.signature
);
console.log('Sender verified:', recoveredFrom === existingTx.from);


// --- 4. ç›£è½ pending äº¤æ˜“ ---
provider.on('pending', async (txHash) => {
  const pendingTx = await provider.getTransaction(txHash);
  if (pendingTx) {
    console.log(`Pending: ${txHash} from ${pendingTx.from} value ${ethers.formatEther(pendingTx.value)} ETH`);
  }
});


// --- 5. Flashbots æäº¤ï¼ˆæ¦‚å¿µç¯„ä¾‹ï¼‰ ---
// å¯¦éš›ä½¿ç”¨éœ€å®‰è£ @flashbots/ethers-provider-bundle
// const flashbotsProvider = await FlashbotsBundleProvider.create(provider, authSigner);
// const bundle = [{ signedTransaction: signedTx }];
// const result = await flashbotsProvider.sendBundle(bundle, targetBlock);
å¸¸è¦‹éŒ¯èª¤
Section titled â€œå¸¸è¦‹éŒ¯èª¤â€
éŒ¯èª¤è¨Šæ¯	åŸå› 
nonce too low	nonce å·²è¢«ä½¿ç”¨é
nonce too high	nonce è·³è™Ÿï¼Œä¸­é–“æœ‰æœªç¢ºèªäº¤æ˜“
insufficient funds	é¤˜é¡ä¸è¶³ä»¥æ”¯ä»˜ value + gas
intrinsic gas too low	gasLimit ä½æ–¼æœ€ä½è¦æ±‚
max fee per gas less than block base fee	maxFeePerGas ä½æ–¼ç•¶å‰ baseFee
already known	æ­¤äº¤æ˜“å·²åœ¨ mempool ä¸­
replacement transaction underpriced	æ›¿æ›äº¤æ˜“çš„ gas price ä¸å¤ é«˜
ç›¸é—œæ¦‚å¿µ
Section titled â€œç›¸é—œæ¦‚å¿µâ€
äº¤æ˜“ç”Ÿå‘½é€±æœŸ - æœ¬ç­†è¨˜æ˜¯æµç¨‹ç¬¬å››æ­¥
äº¤æ˜“ç°½å - æµç¨‹ä¸Šä¸€æ­¥ï¼šç”¢ç”Ÿç°½ç« 
è¨˜æ†¶æ±  - æµç¨‹ä¸‹ä¸€æ­¥ï¼šé€šéé©—è­‰å¾Œé€²å…¥ mempool
ECRECOVER - é©—è­‰ä¸­çš„ç°½ç« æ¢å¾©æ“ä½œ
Keccak-256 - äº¤æ˜“é›œæ¹Šè¨ˆç®—
EIP-155 é‡æ”¾ä¿è­· - ç°½ç« ä¸­çš„ chain ID é©—è­‰
Nonce - nonce é€£çºŒæ€§æª¢æŸ¥
Gas - intrinsic gas å’Œ gas limit é©—è­‰
ä¸Šä¸€é¡µ
äº¤æ˜“ç°½å
ä¸‹ä¸€é¡µ
è¨˜æ†¶æ± 
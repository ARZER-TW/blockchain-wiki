ç‹€æ…‹è½‰æ›
äº¤æ˜“æµç¨‹è·¯å¾‘
Step 9/9
Mark as read
â† å…±è­˜èˆ‡æœ€çµ‚æ€§
Path complete!
ç‹€æ…‹è½‰æ›
Section titled â€œç‹€æ…‹è½‰æ›â€
æ¦‚è¿°
Section titled â€œæ¦‚è¿°â€

ç‹€æ…‹è½‰æ›æ˜¯ Ethereum çš„æ ¸å¿ƒè¨ˆç®—éç¨‹ï¼šçµ¦å®šç•¶å‰ä¸–ç•Œç‹€æ…‹ 
ğœ
Ïƒ å’Œä¸€ç­†äº¤æ˜“ 
ğ‘‡
Tï¼ŒEVM åŸ·è¡Œå¾Œç”¢ç”Ÿæ–°ç‹€æ…‹ 
ğœ
â€²
Ïƒ
â€²
ã€‚æ‰€æœ‰å¸³æˆ¶é¤˜é¡ã€åˆç´„å„²å­˜ã€nonce çš„è®Šæ›´éƒ½åæ˜ åœ¨ Merkle Patricia Trie ä¸­ï¼Œæ–°çš„ state root å¯«å…¥ å€å¡Š Headerã€‚é€™æ˜¯äº¤æ˜“ç”Ÿå‘½é€±æœŸçš„æœ€å¾Œä¸€æ­¥ â€” äº¤æ˜“çš„æ•ˆæœåœ¨æ­¤åˆ»å¯¦éš›ç”Ÿæ•ˆã€‚

æ ¸å¿ƒåŸç†
Section titled â€œæ ¸å¿ƒåŸç†â€
ç‹€æ…‹è½‰æ›å‡½æ•¸
Section titled â€œç‹€æ…‹è½‰æ›å‡½æ•¸â€

Ethereum çš„ç‹€æ…‹è½‰æ›å¯ä»¥è¡¨ç¤ºç‚ºï¼š

ğœ
â€²
=
Î¥
(
ğœ
,
ğ‘‡
)
Ïƒ
â€²
=Î¥(Ïƒ,T)

å…¶ä¸­ 
Î¥
Î¥ æ˜¯ç‹€æ…‹è½‰æ›å‡½æ•¸ï¼Œ
ğœ
Ïƒ æ˜¯ä¸–ç•Œç‹€æ…‹ï¼ˆæ‰€æœ‰å¸³æˆ¶çš„æ˜ å°„ï¼‰ï¼Œ
ğ‘‡
T æ˜¯äº¤æ˜“ã€‚

å°æ–¼ä¸€å€‹å€å¡Š 
ğµ
B åŒ…å«çš„äº¤æ˜“åˆ—è¡¨ 
[
ğ‘‡
0
,
ğ‘‡
1
,
.
.
.
,
ğ‘‡
ğ‘›
]
[T
0
	â€‹

,T
1
	â€‹

,...,T
n
	â€‹

]ï¼š

ğœ
0
â†’
ğ‘‡
0
ğœ
1
â†’
ğ‘‡
1
ğœ
2
â‹¯
â†’
ğ‘‡
ğ‘›
ğœ
ğ‘›
+
1
Ïƒ
0
	â€‹

T
0
	â€‹

	â€‹

Ïƒ
1
	â€‹

T
1
	â€‹

	â€‹

Ïƒ
2
	â€‹

â‹¯
T
n
	â€‹

	â€‹

Ïƒ
n+1
	â€‹


äº¤æ˜“åš´æ ¼æŒ‰å€å¡Šå…§çš„é †åºåŸ·è¡Œï¼Œå‰ä¸€ç­†çš„çµæœæ˜¯å¾Œä¸€ç­†çš„è¼¸å…¥ç‹€æ…‹ã€‚

å¸³æˆ¶ç‹€æ…‹
Section titled â€œå¸³æˆ¶ç‹€æ…‹â€

ä¸–ç•Œç‹€æ…‹ 
ğœ
Ïƒ æ˜¯åœ°å€åˆ°å¸³æˆ¶ç‹€æ…‹çš„æ˜ å°„ã€‚æ¯å€‹å¸³æˆ¶åŒ…å«å››å€‹æ¬„ä½ï¼š

æ¬„ä½	èªªæ˜	å„²å­˜ä½ç½®
nonce	äº¤æ˜“è¨ˆæ•¸ï¼ˆEOAï¼‰æˆ–å»ºç«‹çš„åˆç´„æ•¸ï¼ˆåˆç´„å¸³æˆ¶ï¼‰	State Trie
balance	ETH é¤˜é¡ï¼ˆweiï¼‰	State Trie
storageRoot	Storage Trie çš„æ ¹é›œæ¹Š	State Trieï¼ˆå€¼æŒ‡å‘ç¨ç«‹ trieï¼‰
codeHash	åˆç´„ bytecode çš„ Keccak-256 é›œæ¹Š	State Trieï¼ˆcode å¦å­˜ï¼‰

EOA çš„ storageRoot æ˜¯ç©º trie çš„é›œæ¹Šï¼ŒcodeHash æ˜¯ç©º bytes çš„ Keccak-256ã€‚

äº¤æ˜“åŸ·è¡Œæ­¥é©Ÿ
Section titled â€œäº¤æ˜“åŸ·è¡Œæ­¥é©Ÿâ€
1. é è™•ç†
   â”œâ”€â”€ æ‰£é™¤ intrinsic gas
   â”œâ”€â”€ ç™¼é€è€… nonce + 1
   â”œâ”€â”€ ç™¼é€è€…é¤˜é¡ -= value + (gasLimit * effectiveGasPrice)
   â””â”€â”€ æ¥æ”¶è€…é¤˜é¡ += value


2. EVM åŸ·è¡Œï¼ˆè‹¥ to æ˜¯åˆç´„æˆ– data éç©ºï¼‰
   â”œâ”€â”€ è¼‰å…¥åˆç´„ bytecode
   â”œâ”€â”€ åˆå§‹åŒ–åŸ·è¡Œç’°å¢ƒï¼ˆmsg.sender, msg.value, calldata...ï¼‰
   â”œâ”€â”€ é€æ­¥åŸ·è¡Œ opcode
   â”œâ”€â”€ æ¯å€‹ opcode æ‰£é™¤å°æ‡‰ gas
   â”œâ”€â”€ SLOAD/SSTORE è®€å¯« Storage Trie
   â”œâ”€â”€ LOG0-LOG4 ç”¢ç”Ÿäº‹ä»¶æ—¥èªŒ
   â””â”€â”€ å­å‘¼å«ï¼ˆCALL, DELEGATECALL, STATICCALLï¼‰


3. å¾Œè™•ç†
   â”œâ”€â”€ é€€é‚„æœªä½¿ç”¨çš„ gasï¼šsender += remainingGas * effectiveGasPrice
   â”œâ”€â”€ éŠ·æ¯€ baseFee éƒ¨åˆ†ï¼šbaseFee * gasUsedï¼ˆEIP-1559 ç‡ƒç‡’ï¼‰
   â”œâ”€â”€ æ”¯ä»˜ priority fee çµ¦ proposerï¼špriorityFee * gasUsed
   â”œâ”€â”€ è‹¥åŸ·è¡Œå¤±æ•—ï¼ˆrevert/OOGï¼‰ï¼šå›æ»¾ç‹€æ…‹è®Šæ›´ï¼Œgas ä¸é€€
   â””â”€â”€ ç”¢ç”Ÿäº¤æ˜“å›åŸ·ï¼ˆReceiptï¼‰
ç‹€æ…‹ Trie æ›´æ–°
Section titled â€œç‹€æ…‹ Trie æ›´æ–°â€

äº¤æ˜“åŸ·è¡Œå¾Œï¼Œè®Šæ›´çš„å¸³æˆ¶è³‡æ–™å¯«å…¥ State Trieï¼ˆMerkle Patricia Trieï¼‰ï¼š

ä¿®æ”¹å¸³æˆ¶çš„ nonceã€balance
åˆç´„çš„ SSTORE ä¿®æ”¹ Storage Trieï¼Œç”¢ç”Ÿæ–°çš„ storageRoot
æ›´æ–°å¾Œçš„å¸³æˆ¶è³‡æ–™ç”¨ RLP ç·¨ç¢¼ åºåˆ—åŒ–ï¼Œæ’å…¥ State Trie
è¨ˆç®—æ–°çš„ state rootï¼ˆ32 bytes é›œæ¹Šï¼‰

State root æ˜¯æ•´å€‹ä¸–ç•Œç‹€æ…‹çš„å¯†ç¢¼å­¸æ‰¿è«¾ â€” ä»»ä½•ä¸€å€‹å¸³æˆ¶çš„ä»»ä½•ä¸€å€‹ bit çš„è®ŠåŒ–ï¼Œéƒ½æœƒå°è‡´å®Œå…¨ä¸åŒçš„ state rootã€‚

äº¤æ˜“å›åŸ·ï¼ˆReceiptï¼‰
Section titled â€œäº¤æ˜“å›åŸ·ï¼ˆReceiptï¼‰â€

æ¯ç­†äº¤æ˜“ç”¢ç”Ÿä¸€å€‹ receiptï¼ŒåŒ…å«ï¼š

æ¬„ä½	èªªæ˜
status	1 = æˆåŠŸï¼Œ0 = å¤±æ•—
cumulativeGasUsed	å€å¡Šä¸­æˆªæ­¢æ­¤äº¤æ˜“ç´¯è¨ˆ gas
logsBloom	æ­¤äº¤æ˜“çš„ Bloom Filterï¼ˆ256 bytesï¼‰
logs[]	äº‹ä»¶æ—¥èªŒåˆ—è¡¨ï¼ˆaddress, topics, dataï¼‰

æ‰€æœ‰ receipt çµ„æˆ Receipt Trieï¼Œå…¶æ ¹é›œæ¹Šå¯«å…¥å€å¡Š headerã€‚

Gas è¨ˆç®—
Section titled â€œGas è¨ˆç®—â€

æ¯å€‹ EVM opcode æœ‰å›ºå®šçš„ gas æˆæœ¬ï¼ˆéƒ¨åˆ†æ˜¯å‹•æ…‹çš„ï¼‰ï¼š

Opcode	Gas	èªªæ˜
ADD, SUB	3	ç®—è¡“é‹ç®—
MUL, DIV	5	ä¹˜é™¤
SLOAD	2,100 (cold) / 100 (warm)	è®€å– storage
SSTORE	20,000 (new) / 5,000 (update)	å¯«å…¥ storage
CALL	2,600 (cold) + value transfer	å¤–éƒ¨å‘¼å«
CREATE	32,000 + deployment	å»ºç«‹åˆç´„

EIP-2929 å¼•å…¥äº† cold/warm å­˜å–æ¦‚å¿µï¼šç¬¬ä¸€æ¬¡å­˜å–ï¼ˆcoldï¼‰è¼ƒè²´ï¼ŒåŒä¸€äº¤æ˜“ä¸­å†æ¬¡å­˜å–ï¼ˆwarmï¼‰ä¾¿å®œã€‚Access listï¼ˆEIP-2930ï¼‰å¯ä»¥é ä»˜ cold å­˜å–è²»ç”¨ã€‚

Revert èˆ‡ Out-of-Gas
Section titled â€œRevert èˆ‡ Out-of-Gasâ€
REVERTï¼šå›æ»¾æ‰€æœ‰ç‹€æ…‹è®Šæ›´ï¼Œé€€é‚„å‰©é¤˜ gasã€‚calldata ä¸­å¯å¸¶ error message
Out-of-Gas (OOG)ï¼šgas ç”¨å®Œï¼Œå›æ»¾ç‹€æ…‹è®Šæ›´ï¼Œä¸é€€ gas
å¤–å±¤ vs å…§å±¤ï¼šå­å‘¼å«çš„ revert å¯ä»¥è¢«å¤–å±¤ catchï¼ˆCALL å›å‚³ 0ï¼‰ï¼Œä¸ä¸€å®šå°è‡´æ•´ç­†äº¤æ˜“å¤±æ•—

å…©ç¨®æƒ…æ³ä¸‹ï¼Œäº¤æ˜“æœ¬èº«éƒ½ç®—ã€Œè¢«åŒ…å«åœ¨å€å¡Šä¸­ã€ï¼Œnonce éå¢ï¼Œgas è²»ç…§æ”¶ã€‚

åœ¨ Ethereum ä¸­çš„æ‡‰ç”¨
Section titled â€œåœ¨ Ethereum ä¸­çš„æ‡‰ç”¨â€
ETH è½‰å¸³ï¼šæœ€ç°¡å–®çš„ç‹€æ…‹è½‰æ› â€” åªä¿®æ”¹å…©å€‹å¸³æˆ¶çš„ balance
åˆç´„äº’å‹•ï¼šEVM åŸ·è¡Œ bytecodeï¼Œå¯èƒ½ä¿®æ”¹å¤šå€‹å¸³æˆ¶çš„ storage
åˆç´„éƒ¨ç½²ï¼šå‰µå»ºæ–°å¸³æˆ¶ï¼ŒcodeHash å¾ç©ºè®Šç‚ºåˆç´„ bytecode çš„é›œæ¹Š
è‡ªæ¯€ï¼ˆdeprecatedï¼‰ï¼šSELFDESTRUCT æ›¾ç¶“åˆªé™¤å¸³æˆ¶ï¼ŒDencun å¾Œåªè½‰å¸³ä¸åˆªé™¤
ç¨‹å¼ç¢¼ç¯„ä¾‹
Section titled â€œç¨‹å¼ç¢¼ç¯„ä¾‹â€
import { ethers } from 'ethers';


const provider = new ethers.JsonRpcProvider('http://localhost:8545');


// --- 1. è§€å¯Ÿç‹€æ…‹è½‰æ›å‰å¾Œ ---
async function observeStateChange(txHash) {
  const tx = await provider.getTransaction(txHash);
  const receipt = await provider.getTransactionReceipt(txHash);


  // å–å¾—äº¤æ˜“æ‰€åœ¨å€å¡Šçš„å‰ä¸€å€‹å€å¡Šï¼ˆäº¤æ˜“å‰ç‹€æ…‹ï¼‰
  const preBlock = receipt.blockNumber - 1;


  // ç™¼é€è€…ç‹€æ…‹è®ŠåŒ–
  const [senderBefore, senderAfter] = await Promise.all([
    provider.getBalance(tx.from, preBlock),
    provider.getBalance(tx.from, receipt.blockNumber),
  ]);


  // æ¥æ”¶è€…ç‹€æ…‹è®ŠåŒ–
  const [receiverBefore, receiverAfter] = await Promise.all([
    provider.getBalance(tx.to, preBlock),
    provider.getBalance(tx.to, receipt.blockNumber),
  ]);


  const gasUsed = receipt.gasUsed;
  const effectiveGasPrice = receipt.gasPrice; // actual price paid
  const gasCost = gasUsed * effectiveGasPrice;


  console.log('--- State Transition ---');
  console.log('Sender balance delta:', ethers.formatEther(senderAfter - senderBefore), 'ETH');
  console.log('Receiver balance delta:', ethers.formatEther(receiverAfter - receiverBefore), 'ETH');
  console.log('Gas cost:', ethers.formatEther(gasCost), 'ETH');
  console.log('Status:', receipt.status === 1 ? 'Success' : 'Reverted');
}


// --- 2. è®€å–åˆç´„ storage slot ---
async function readStorage(contractAddr, slot) {
  const value = await provider.getStorage(contractAddr, slot);
  console.log(`Storage[${slot}]:`, value);
  return value;
}


// ERC-20 balanceOf é€šå¸¸åœ¨ slot = keccak256(address . slot_index)
const userAddr = '0xUserAddress';
const balanceMappingSlot = 0; // å‡è¨­ balances mapping åœ¨ slot 0
const storageKey = ethers.keccak256(
  ethers.AbiCoder.defaultAbiCoder().encode(
    ['address', 'uint256'],
    [userAddr, balanceMappingSlot]
  )
);
await readStorage('0xTokenContract', storageKey);


// --- 3. è¿½è¹¤äº¤æ˜“çš„ state diffï¼ˆéœ€è¦ debug APIï¼‰ ---
// const trace = await provider.send('debug_traceTransaction', [
//   txHash,
//   { tracer: 'prestateTracer' }
// ]);


// --- 4. è§£æäº¤æ˜“å›åŸ·ä¸­çš„äº‹ä»¶ ---
async function parseReceipt(txHash) {
  const receipt = await provider.getTransactionReceipt(txHash);
  console.log('Status:', receipt.status);
  console.log('Gas Used:', receipt.gasUsed.toString());
  console.log('Logs:');
  for (const log of receipt.logs) {
    console.log(`  Contract: ${log.address}`);
    console.log(`  Topics: ${log.topics}`);
    console.log(`  Data: ${log.data}`);
  }
}


// --- 5. ç”¨ Proof é©—è­‰å¸³æˆ¶ç‹€æ…‹ ---
async function verifyAccountState(address, blockTag) {
  const tag = blockTag || 'latest';
  const proof = await provider.send('eth_getProof', [address, [], tag]);
  console.log('Nonce:', parseInt(proof.nonce, 16));
  console.log('Balance:', ethers.formatEther(BigInt(proof.balance)));
  console.log('Storage Hash:', proof.storageHash);
  console.log('Code Hash:', proof.codeHash);
  console.log('Proof length:', proof.accountProof.length, 'nodes');
}
ç›¸é—œæ¦‚å¿µ
Section titled â€œç›¸é—œæ¦‚å¿µâ€
äº¤æ˜“ç”Ÿå‘½é€±æœŸ - æœ¬ç­†è¨˜æ˜¯æµç¨‹ç¬¬å…«æ­¥ï¼ˆæœ€å¾Œï¼‰
å…±è­˜èˆ‡æœ€çµ‚æ€§ - æµç¨‹ä¸Šä¸€æ­¥ï¼šå€å¡Šè¢«ç¢ºèªå¾Œç‹€æ…‹ç”Ÿæ•ˆ
Merkle Patricia Trie - ç‹€æ…‹å„²å­˜çš„æ ¸å¿ƒè³‡æ–™çµæ§‹
State Trie - å…¨åŸŸå¸³æˆ¶ç‹€æ…‹æ¨¹
Storage Trie - åˆç´„å„²å­˜æ¨¹
Transaction Trie - å€å¡Šå…§äº¤æ˜“æ¨¹
Receipt Trie - äº¤æ˜“å›åŸ·æ¨¹
RLP ç·¨ç¢¼ - å¸³æˆ¶è³‡æ–™åºåˆ—åŒ–
Keccak-256 - state rootã€storage key è¨ˆç®—
EOA - å¤–éƒ¨å¸³æˆ¶çš„ç‹€æ…‹çµæ§‹
åˆç´„å¸³æˆ¶ - åˆç´„å¸³æˆ¶çš„ç‹€æ…‹çµæ§‹
Gas - EVM åŸ·è¡Œçš„è¨ˆé‡
Bloom Filter - logsBloom å¿«é€Ÿéæ¿¾
Precompiled Contracts - æä¾›å¯†ç¢¼å­¸é‹ç®—çš„é ç·¨è­¯åˆç´„
ä¸Šä¸€é¡µ
å…±è­˜èˆ‡æœ€çµ‚æ€§
ä¸‹ä¸€é¡µ
Beacon Chain